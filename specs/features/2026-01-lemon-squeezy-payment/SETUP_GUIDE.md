# License System Setup Guide

This guide covers setting up and managing the license system for PDF Finder Pro.

## Table of Contents
- [Architecture Overview](#architecture-overview)
- [Lemon Squeezy Setup](#lemon-squeezy-setup)
- [License Key Generation](#license-key-generation)
- [Testing the System](#testing-the-system)
- [User Activation Flow](#user-activation-flow)
- [Support & Troubleshooting](#support--troubleshooting)

---

## Architecture Overview

### Offline-First Design
The license system is designed to work **completely offline** after initial activation:
- No backend validation service required
- No periodic online checks
- Zero ongoing infrastructure costs
- Works forever without internet

### How It Works
1. **License Keys**: Cryptographically signed using HMAC-SHA256
2. **Validation**: Entirely local - verifies signature using embedded secret
3. **Storage**: Simple JSON file in platform-specific data directory
4. **Trial**: 14-day period tracked via first-launch timestamp

### Key Components
- **Rust Backend** (`src-tauri/src/`):
  - `license.rs` - License data structure and file I/O
  - `validation.rs` - Cryptographic signature verification
  - `bin/generate-keys.rs` - License key generation tool
  
- **Frontend** (`license-ui.js`):
  - Welcome screen for first launch
  - License activation dialog
  - Trial banner and expiration notices
  - Result limiting (10 items when expired)

---

## Lemon Squeezy Setup

### 1. Create Account
1. Go to [lemonsqueezy.com](https://lemonsqueezy.com)
2. Sign up for a new account
3. Complete email verification
4. Set up your store information

### 2. Create Product
1. Navigate to Products → Add Product
2. Configure:
   ```
   Product Name: PDF Finder Pro - Lifetime License
   Price: $5.00 USD
   Type: Single Payment (not subscription)
   Description: Lifetime license for PDF Finder Pro desktop application
   ```

3. **Enable License Keys** (Important):
   - In product settings, enable "Generate license keys"
   - **Import Pre-Generated Keys** (Recommended):
     - Use keys generated by our tool (see next section)
     - Upload as CSV with single column: `license_key`
   - OR use Lemon Squeezy's auto-generation:
     - Set format to custom prefix: `PDFPRO-`
     - Set length to match our format
     - ⚠️ Note: Auto-generated keys won't validate with our signature

### 3. Configure Checkout
1. Email Collection:
   - Require: Email only
   - Don't collect billing address (reduces friction)

2. Branding:
   - Upload PDF Finder Pro logo
   - Set brand colors to match app theme
   - Enable dark mode support

3. Success Page:
   - Redirect URL: `https://pdffinderpro.com/activated` (or your domain)
   - Show success message with activation instructions

### 4. Email Templates
Customize the license delivery email:

```
Subject: Your PDF Finder Pro License Key

Hi there!

Thank you for purchasing PDF Finder Pro! Here's your license key:

{{license_key}}

To activate:
1. Open PDF Finder Pro
2. Click "Enter License Key" 
3. Paste the key above
4. Click "Activate"

Your license works on unlimited devices and never expires.
Activation works completely offline - no internet required!

Need help? Reply to this email.

Thanks for your support!
- PDF Finder Pro Team
```

### 5. Test Mode
1. Enable test mode in Lemon Squeezy dashboard
2. Use test credit card: `4242 4242 4242 4242`
3. Complete test purchase
4. Verify email delivery
5. Test license key in application

### 6. Production Mode
1. Switch to production mode
2. Verify webhook settings (if using)
3. Test real $5 purchase
4. Monitor sales in dashboard

---

## License Key Generation

### Overview
License keys are generated using a command-line tool that creates cryptographically signed keys. These keys are then uploaded to Lemon Squeezy for distribution.

### Key Format
```
PDFPRO-XXXX-XXXX-XXXX-XXXX-YYYY
```
- **PDFPRO**: Prefix (7 chars)
- **XXXX-XXXX-XXXX-XXXX**: Data (timestamp + random, 16 hex chars)
- **YYYY**: HMAC signature (4 chars, base32 encoded)

### Generate Keys

#### Prerequisites
- Rust installed
- Access to `src-tauri` directory

#### Step 1: Build the Tool
```bash
cd src-tauri
cargo build --bin generate-keys --release
```

#### Step 2: Generate Keys
```bash
# Generate 100 keys
cargo run --bin generate-keys --release 100

# Output will be CSV format:
# license_key
# PDFPRO-A7B2-C9D4-E1F6-G8H3-K2M4
# PDFPRO-B8C3-D0E5-F7G9-H4J6-L3N5
# ...
```

#### Step 3: Save Output
```bash
# Save to file
cargo run --bin generate-keys --release 100 > license-keys.csv
```

#### Step 4: Upload to Lemon Squeezy
1. Go to your product in Lemon Squeezy dashboard
2. Navigate to License Keys section
3. Click "Import Keys"
4. Upload `license-keys.csv`
5. Verify import successful

### Key Management Best Practices

1. **Generate in Batches**: Create 1000+ keys at a time
2. **Keep Backup**: Store CSV securely (encrypted)
3. **Never Commit**: Add to `.gitignore`
4. **Rotate Secret**: Change HMAC secret in major versions
5. **Monitor Usage**: Track key distribution in Lemon Squeezy

### Security Notes

⚠️ **Secret Key Management**:
- The HMAC secret is in `validation.rs`: `HMAC_SECRET`
- Default is placeholder - **MUST** change before production
- Keep secret private - never commit to public repo
- Rotate periodically (major version updates)

**Changing the Secret**:
```rust
// In src-tauri/src/validation.rs
const HMAC_SECRET: &str = "your_random_secret_here_min_32_chars";

// Also update in src-tauri/src/bin/generate-keys.rs
const HMAC_SECRET: &str = "your_random_secret_here_min_32_chars";
```

Generate strong secret:
```bash
openssl rand -base64 32
```

---

## Testing the System

### Local Testing (Development)

#### Test Trial Mode
1. Delete trial timestamp:
   ```bash
   # macOS
   rm ~/Library/Application\ Support/pdf-finder-pro/trial.timestamp
   
   # Linux
   rm ~/.local/share/pdf-finder-pro/trial.timestamp
   
   # Windows
   del %LOCALAPPDATA%\pdf-finder-pro\trial.timestamp
   ```

2. Launch app
3. Verify welcome screen appears
4. Check trial banner shows 14 days

#### Test License Activation
1. Generate a test key:
   ```bash
   cd src-tauri
   cargo run --bin generate-keys 1
   ```

2. Copy the generated key
3. Click "Enter License Key" in app
4. Paste and activate
5. Verify success message
6. Restart app - should not show trial banner

#### Test Trial Expiration
1. Modify trial timestamp to simulate expiration:
   ```bash
   # Set to 15 days ago (86400 * 15 seconds)
   date -u -r $(($(date +%s) - 1296000)) +%s > \
     ~/Library/Application\ Support/pdf-finder-pro/trial.timestamp
   ```

2. Launch app
3. Verify expiration notice appears
4. Search PDFs - verify limited to 10 results

#### Test Invalid Keys
1. Enter malformed key: `PDFPRO-AAAA-BBBB-CCCC-DDDD-EEEE`
2. Verify error: "Invalid license key"
3. Try with wrong prefix: `WRONG-AAAA-BBBB-CCCC-DDDD-EEEE`
4. Verify format validation catches it

### Integration Testing

#### End-to-End Purchase Flow
1. **Setup**:
   - Enable Lemon Squeezy test mode
   - Upload test keys to product

2. **Purchase**:
   - Visit checkout URL
   - Complete test purchase
   - Check email for license key

3. **Activation**:
   - Open app
   - Enter received license key
   - Verify activation successful

4. **Validation**:
   - Close app
   - Disconnect internet
   - Reopen app
   - Verify still licensed (offline works)

### Cross-Platform Testing

Test on all supported platforms:
- [ ] Windows 10/11
- [ ] macOS (Intel)
- [ ] macOS (Apple Silicon)
- [ ] Linux (Ubuntu)
- [ ] Linux (Fedora)

For each platform:
1. Fresh install
2. First launch → welcome screen
3. Start trial → banner appears
4. Purchase → activate → verify
5. Offline mode → restart → still works

---

## User Activation Flow

### Normal Purchase Path
1. User visits landing page
2. Clicks "Buy Now" → Lemon Squeezy checkout
3. Completes $5 payment
4. Receives email with license key
5. Opens PDF Finder Pro
6. Clicks "Enter License Key"
7. Pastes key → Activates (instantly, offline)
8. Full access forever

### Trial Path
1. User downloads and installs
2. First launch → Welcome screen
3. Clicks "Start Free Trial"
4. 14 days full access
5. Trial banner shows countdown
6. Day 15 → Expiration notice
7. Search limited to 10 results
8. Click "Buy Now" → Purchase flow
9. Activate → Full access restored

### Key Features
- **Instant Activation**: No API calls, validates locally
- **Offline Forever**: Works without internet after activation
- **Multi-Device**: Same key works on unlimited devices
- **No Hassle**: Copy-paste key, done in 10 seconds

---

## Support & Troubleshooting

### Common User Issues

#### "Invalid License Key"
**Cause**: Typo, incorrect format, or signature mismatch

**Solution**:
1. Verify format: `PDFPRO-XXXX-XXXX-XXXX-XXXX-XXXX`
2. Check for spaces or extra characters
3. Copy directly from email (don't retype)
4. Try copy-paste instead of manual entry

#### "License File Corrupted"
**Cause**: Corrupted JSON file on disk

**Solution**:
1. Delete license file:
   ```bash
   # macOS
   rm ~/Library/Application\ Support/pdf-finder-pro/license.key
   
   # Linux
   rm ~/.local/share/pdf-finder-pro/license.key
   
   # Windows
   del %LOCALAPPDATA%\pdf-finder-pro\license.key
   ```
2. Reactivate with license key

#### Trial Doesn't Start
**Cause**: Trial timestamp file already exists

**Solution**:
1. Check if file exists
2. If corrupted, delete and restart app
3. First launch should create new timestamp

#### Search Results Still Limited
**Cause**: License not activated properly

**Solution**:
1. Check license status in app
2. Verify license key is saved
3. Try deactivate → reactivate
4. Check console for errors

### Admin Tools

#### Verify License Status
```bash
# Check if license file exists
ls ~/Library/Application\ Support/pdf-finder-pro/license.key

# View license (it's plain JSON)
cat ~/Library/Application\ Support/pdf-finder-pro/license.key
```

#### Reset Trial Period
```bash
# WARNING: Only for testing!
rm ~/Library/Application\ Support/pdf-finder-pro/trial.timestamp
```

#### Check Key Validity
Use Rust tests:
```bash
cd src-tauri
cargo test verify_license_key_signature -- --nocapture
```

### Refund Process

**Policy**: 14-day money-back guarantee

**Steps**:
1. User requests refund via email
2. Admin verifies purchase in Lemon Squeezy
3. Issue refund through dashboard
4. ⚠️ **Note**: Key cannot be revoked (offline system)
5. Accept some keys may continue working

**Prevention**:
- Clearly communicate trial period
- Make trial generous (14 days)
- Focus on honest users, not pirates

---

## Maintenance

### Key Rotation (Major Versions)
When releasing major version (e.g., 2.0):

1. Generate new HMAC secret
2. Update both `validation.rs` and `generate-keys.rs`
3. Generate new batch of keys
4. Upload to Lemon Squeezy product
5. ⚠️ Old keys will stop working in new version
6. Offer free upgrade to existing customers

### Monitoring
**Lemon Squeezy Dashboard**:
- Sales count
- Revenue tracking
- Failed payments
- Refund rate

**App Metrics** (Optional):
- Could add anonymous telemetry
- Track activation success rate
- Monitor error patterns
- ⚠️ Privacy concerns - keep minimal

### Scaling
Current system handles:
- Unlimited license activations
- Zero server load
- No rate limits
- No infrastructure costs

As sales grow:
- Generate larger key batches (10k+)
- Monitor Lemon Squeezy fees
- Consider volume licensing

---

## Security Considerations

### Threat Model
**Accept**: Some users will share keys or extract secret
**Mitigate**: $5 price reduces piracy incentive
**Focus**: Honest users, not DRM warfare

### What's Protected
✅ Casual copying (format validation)
✅ Random guessing (cryptographic signature)
✅ Signature forgery (HMAC-SHA256)

### What's Not Protected
❌ Key sharing (accept some loss)
❌ Secret extraction from binary (accept trade-off)
❌ Trial manipulation (basic timestamp check only)

### Best Practices
1. Rotate secret in major versions
2. Monitor for public key leaks
3. Keep secret out of public repos
4. Don't over-invest in DRM
5. Trust your users

---

## FAQ

**Q: Can users share license keys?**
A: Technically yes. We accept this trade-off for simplicity. $5 price reduces sharing incentive.

**Q: What if someone extracts the HMAC secret?**
A: They could generate keys. We can rotate the secret in updates. Focus on honest users.

**Q: Why offline-only?**
A: Zero ongoing costs, better privacy, simpler implementation, works forever.

**Q: Can we revoke licenses?**
A: No. Offline design means no revocation. Only issue refunds, can't disable keys.

**Q: What about enterprise licensing?**
A: Future feature. Current system uses same key for all devices.

**Q: How to handle updates?**
A: License valid across versions. In major versions, can offer upgrade path.

---

## Resources

- [Lemon Squeezy Documentation](https://docs.lemonsqueezy.com/)
- [Tauri Security Best Practices](https://tauri.app/security/)
- [HMAC Wikipedia](https://en.wikipedia.org/wiki/HMAC)
- Specification: `specs/features/2026-01-lemon-squeezy-payment/`

---

*Last Updated: 2026-01-07*
*Version: 1.0*
